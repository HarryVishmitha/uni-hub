import { Link } from '@inertiajs/react';
import { useEffect, useId, useState, useRef } from "react";
import ThemeToggle from '@/Components/ThemeToggle';
import { Icon } from '@iconify/react';

const AppLayout = ({ children }) => {

    const top_changeable_links = [
        { 
            name: 'Home', 
            href: '/', 
            icon: 'mdi:home' 
        },
        { 
            name: 'Courses', 
            href: '/courses', 
            icon: 'mdi:book-open-page-variant',
            megaMenu: true,
            megaMenuContent: {
                featured: {
                    title: 'Featured Courses',
                    items: [
                        { name: 'Computer Science', href: '/courses/computer-science', description: 'Learn programming, algorithms, and software development' },
                        { name: 'Business Administration', href: '/courses/business', description: 'Study business management, finance, and marketing' },
                    ]
                },
                categories: [
                    {
                        title: 'Undergraduate',
                        items: [
                            { name: 'Arts & Humanities', href: '/courses/arts' },
                            { name: 'Science & Technology', href: '/courses/science' },
                            { name: 'Business & Economics', href: '/courses/business' },
                            { name: 'Health & Medicine', href: '/courses/health' },
                        ]
                    },
                    {
                        title: 'Graduate',
                        items: [
                            { name: 'Master\'s Programs', href: '/courses/masters' },
                            { name: 'Doctoral Programs', href: '/courses/doctoral' },
                            { name: 'Professional Certificates', href: '/courses/certificates' },
                        ]
                    },
                    {
                        title: 'Online Learning',
                        items: [
                            { name: 'Self-paced Courses', href: '/courses/self-paced' },
                            { name: 'Live Online Classes', href: '/courses/live-online' },
                            { name: 'Blended Programs', href: '/courses/blended' },
                        ]
                    }
                ]
            }
        },
        { 
            name: 'Admissions', 
            href: '/admissions', 
            icon: 'mdi:school',
            megaMenu: true,
            megaMenuContent: {
                featured: {
                    title: 'Admission Information',
                    items: [
                        { name: 'Application Process', href: '/admissions/process', description: 'Step-by-step guide to applying' },
                        { name: 'Financial Aid', href: '/admissions/financial-aid', description: 'Scholarships, grants, and loans information' },
                    ]
                },
                categories: [
                    {
                        title: 'Apply',
                        items: [
                            { name: 'Undergraduate', href: '/admissions/undergraduate' },
                            { name: 'Graduate', href: '/admissions/graduate' },
                            { name: 'International', href: '/admissions/international' },
                            { name: 'Transfer', href: '/admissions/transfer' },
                        ]
                    },
                    {
                        title: 'Resources',
                        items: [
                            { name: 'Visit Campus', href: '/admissions/visit' },
                            { name: 'Tuition & Fees', href: '/admissions/tuition' },
                            { name: 'Deadlines', href: '/admissions/deadlines' },
                        ]
                    }
                ]
            }
        },
        { name: 'Student Portal', href: '/student-portal', icon: 'mdi:account-school' },
        { name: 'Resources', href: '/resources', icon: 'mdi:file-document-multiple' },
    ];


    const [open, setOpen] = useState(false);
    const [scrolled, setScrolled] = useState(false);
    const [dropdownOpen, setDropdownOpen] = useState(null);
    const [activeMegaMenu, setActiveMegaMenu] = useState(null);
    const [bannerVisible, setBannerVisible] = useState(true);
    const [isFloating, setIsFloating] = useState(false);
    const headerRef = useRef(null);
    const menuLabelId = useId();
    
    // Handle clicks outside to close dropdowns and mega menus
    useEffect(() => {
        const closeMenus = (e) => {
            // Don't close if clicking inside a mega menu or dropdown toggle button
            if (
                e.target.closest('[data-mega-menu]') ||
                e.target.closest('[data-dropdown-toggle]')
            ) return;
            
            setDropdownOpen(null);
            setActiveMegaMenu(null);
        };
        
        document.addEventListener('click', closeMenus);
        return () => document.removeEventListener('click', closeMenus);
    }, []);

    // Shadow + compact height on scroll and banner visibility
    useEffect(() => {
        const onScroll = () => {
            const scrollPosition = window.scrollY;
            setScrolled(scrollPosition > 8);
            
            // Hide banner and set floating header after scrolling past 100px
            if (scrollPosition > 100) {
                setBannerVisible(false);
                setIsFloating(true);
            } else {
                setBannerVisible(true);
                setIsFloating(false);
            }
        };
        
        onScroll();
        window.addEventListener("scroll", onScroll, { passive: true });
        return () => window.removeEventListener("scroll", onScroll);
    }, []);

    // Handle mega menu
    const toggleMegaMenu = (name, e) => {
        e.preventDefault();
        e.stopPropagation();
        setActiveMegaMenu(activeMegaMenu === name ? null : name);
        // Close any open dropdowns when opening a mega menu
        setDropdownOpen(null);
    };
    
    // ESC key handler for closing menus
    useEffect(() => {
        const onKey = (e) => {
            if (e.key === "Escape") {
                setOpen(false);
                setDropdownOpen(null);
                setActiveMegaMenu(null);
            }
        };
        window.addEventListener("keydown", onKey);
        return () => window.removeEventListener("keydown", onKey);
    }, []);
    
    // Close on route change (Inertia)
    useEffect(() => {
        const onPop = () => {
            setOpen(false);
            setDropdownOpen(null);
            setActiveMegaMenu(null);
        };
        window.addEventListener("popstate", onPop);
        return () => window.removeEventListener("popstate", onPop);
    }, []);

    return (
        <div className="app-layout bg-gray-50 dark:bg-gray-800 min-h-screen flex flex-col">
            <header
                ref={headerRef}
                className={[
                    "sticky top-0 z-50 w-full",
                    isFloating ? "shadow-xl animate-slideDown" : "",
                ].join(" ")}
            >
                {/* Skip link for a11y */}
                <a
                    href="#main"
                    className="sr-only focus:not-sr-only absolute left-2 top-2 rounded bg-blue-600 px-3 py-1 text-white"
                >
                    Skip to content
                </a>

                {/* Notification Banner - Conditionally shown */}
                {bannerVisible && (
                    <div className="bg-blue-600 text-white px-4 py-1.5 text-center text-sm">
                        <p className="flex items-center justify-center gap-1.5">
                            <Icon icon="mdi:information" className="text-lg" />
                            <span>Fall 2025 admissions are now open! <Link href="/admissions" className="underline font-medium">Apply now</Link></span>
                        </p>
                    </div>
                )}

                {/* Main Navigation Bar */}
                <div className="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className={[
                            "flex items-center justify-between transition-all duration-200",
                            scrolled ? "h-16" : "h-20"
                        ].join(" ")}>
                            {/* Left Side - Account & Theme Toggle */}
                            <div className="flex items-center gap-4">
                                {/* Theme Toggle */}
                                <ThemeToggle variant="icon" size="md" />
                                
                                {/* User Account */}
                                <div className="relative">
                                    <button 
                                        data-dropdown-toggle="true"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setDropdownOpen(dropdownOpen === 'user' ? null : 'user');
                                            // Close any open mega menu when opening the user dropdown
                                            setActiveMegaMenu(null);
                                        }}
                                        className="flex items-center gap-2 rounded-full bg-gray-100 p-1.5 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700"
                                    >
                                        <Icon icon="mdi:account-circle" className="text-xl" />
                                        <span className="text-sm font-medium">My Account</span>
                                        <Icon icon="mdi:chevron-down" className={`text-sm transition-transform ${dropdownOpen === 'user' ? 'rotate-180' : ''}`} />
                                    </button>
                                    
                                    {/* User Dropdown */}
                                    {dropdownOpen === 'user' && (
                                        <div className="absolute left-0 mt-2 w-48 rounded-md bg-white shadow-lg dark:bg-gray-800 border border-gray-200 dark:border-gray-700 z-50">
                                            <div className="py-1">
                                                <Link href="/profile" className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700">
                                                    <Icon icon="mdi:account" className="inline mr-2" />
                                                    Profile
                                                </Link>
                                                <Link href="/dashboard" className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700">
                                                    <Icon icon="mdi:view-dashboard" className="inline mr-2" />
                                                    Dashboard
                                                </Link>
                                                <Link href="/settings" className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700">
                                                    <Icon icon="mdi:cog" className="inline mr-2" />
                                                    Settings
                                                </Link>
                                                <div className="border-t border-gray-200 dark:border-gray-700"></div>
                                                <Link href="/logout" className="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:text-red-400 dark:hover:bg-gray-700">
                                                    <Icon icon="mdi:logout" className="inline mr-2" />
                                                    Logout
                                                </Link>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                    {/* Desktop Nav */}
                    <nav
                        className="hidden md:flex items-center gap-1 lg:gap-2"
                        aria-label="Primary Navigation"
                    >
                        {top_changeable_links.map((link) => (
                            <Link
                                key={link.name}
                                href={link.href}
                                className="inline-flex items-center gap-1.5 rounded-md px-3 py-2 text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-200 dark:hover:text-blue-400 transition duration-150 ease-in-out hover:bg-gray-100 dark:hover:bg-gray-800"
                                data-analytics-nav={link.name}
                            >
                                {link.icon && <Icon icon={link.icon} className="text-lg" />}
                                <span>{link.name}</span>
                            </Link>
                        ))}

                        {/* User Account & Quick Actions */}
                        <div className="relative ml-2">
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setDropdownOpen(dropdownOpen === 'user' ? null : 'user');
                                }}
                                className="flex items-center gap-2 rounded-full bg-gray-100 p-1.5 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700"
                            >
                                <Icon icon="mdi:account-circle" className="text-xl" />
                                <span className="hidden lg:inline text-sm font-medium">My Account</span>
                                <Icon icon="mdi:chevron-down" className={`text-sm transition-transform ${dropdownOpen === 'user' ? 'rotate-180' : ''}`} />
                            </button>
                            
                            {/* User Dropdown */}
                            {dropdownOpen === 'user' && (
                                <div className="absolute right-0 mt-2 w-48 rounded-md bg-white shadow-lg dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                                    <div className="py-1">
                                        <Link href="/profile" className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700">
                                            <Icon icon="mdi:account" className="inline mr-2" />
                                            Profile
                                        </Link>
                                        <Link href="/dashboard" className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700">
                                            <Icon icon="mdi:view-dashboard" className="inline mr-2" />
                                            Dashboard
                                        </Link>
                                        <Link href="/settings" className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700">
                                            <Icon icon="mdi:cog" className="inline mr-2" />
                                            Settings
                                        </Link>
                                        <div className="border-t border-gray-200 dark:border-gray-700"></div>
                                        <Link href="/logout" className="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:text-red-400 dark:hover:bg-gray-700">
                                            <Icon icon="mdi:logout" className="inline mr-2" />
                                            Logout
                                        </Link>
                                    </div>
                                </div>
                            )}
                        </div>

                        <ThemeToggle variant="icon" size="md" />
                    </nav>

                    {/* Mobile Controls */}
                    <div className="flex md:hidden items-center gap-3">
                        <Link href="/search" className="text-gray-700 dark:text-gray-200">
                            <Icon icon="mdi:magnify" className="text-2xl" />
                        </Link>
                        <ThemeToggle variant="icon" size="md" />
                        <button
                            type="button"
                            className="inline-flex items-center justify-center rounded-md p-2 text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800 transition"
                            aria-controls="mobile-nav"
                            aria-expanded={open}
                            aria-haspopup="dialog"
                            aria-label="Open menu"
                            onClick={() => setOpen(true)}
                        >
                            <Icon icon="mdi:menu" className="text-2xl" />
                        </button>
                    </div>
                </div>

                {/* Notification Banner - Can be conditionally shown */}
                <div className="bg-blue-600 text-white px-4 py-1.5 text-center text-sm">
                    <p className="flex items-center justify-center gap-1.5">
                        <Icon icon="mdi:information" className="text-lg" />
                        <span>Fall 2025 admissions are now open! <Link href="/admissions" className="underline font-medium">Apply now</Link></span>
                    </p>
                </div>

                {/* Mobile Sheet / Drawer */}
                <div
                    // Backdrop
                    className={[
                        "md:hidden fixed inset-0 z-[60] bg-black/50 transition-opacity",
                        open ? "opacity-100" : "pointer-events-none opacity-0",
                    ].join(" ")}
                    onClick={() => setOpen(false)}
                />

                <aside
                    id="mobile-nav"
                    role="dialog"
                    aria-modal="true"
                    aria-labelledby={menuLabelId}
                    className={[
                        "md:hidden fixed right-0 top-0 z-[70] h-full w-80 max-w-[85vw] bg-white dark:bg-gray-900 shadow-xl transition-transform",
                        open ? "translate-x-0" : "translate-x-full",
                    ].join(" ")}
                >
                    <div className="flex items-center justify-between border-b border-gray-200 dark:border-gray-700 px-4 py-3">
                        <div className="flex items-center gap-2">
                            <img
                                src="/assets/logo-full.png"
                                alt="Uni-Hub Logo"
                                className="block dark:hidden w-28"
                            />
                            <img
                                src="/assets/logo-full-dark.png"
                                alt="Uni-Hub Logo"
                                className="hidden dark:block w-28"
                            />
                        </div>

                        {/* Close button */}
                        <button
                            type="button"
                            className="inline-flex items-center justify-center rounded-md p-2 text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800 transition"
                            aria-label="Close menu"
                            onClick={() => setOpen(false)}
                        >
                            <Icon icon="mdi:close" className="text-2xl" />
                        </button>
                    </div>

                    <div className="overflow-y-auto p-3 space-y-1.5">
                        <h2 id={menuLabelId} className="sr-only">
                            Mobile navigation
                        </h2>
                        
                        {/* User Quick Actions */}
                        <div className="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg mb-3">
                            <div className="rounded-full bg-blue-100 p-2 text-blue-600 dark:bg-blue-900 dark:text-blue-300">
                                <Icon icon="mdi:account" className="text-xl" />
                            </div>
                            <div>
                                <p className="font-medium text-gray-900 dark:text-white">Welcome!</p>
                                <div className="flex mt-1 gap-2">
                                    <Link href="/login" className="text-xs text-blue-600 dark:text-blue-400 hover:underline">Log in</Link>
                                    <span className="text-gray-500">|</span>
                                    <Link href="/signup" className="text-xs text-blue-600 dark:text-blue-400 hover:underline">Sign up</Link>
                                </div>
                            </div>
                        </div>

                        {/* Main Navigation Links */}
                        {top_changeable_links.map((link) => (
                            <Link
                                key={link.name}
                                href={link.href}
                                onClick={() => setOpen(false)}
                                className="flex items-center gap-2 rounded-lg px-3 py-2.5 text-base font-medium text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800 transition"
                            >
                                {link.icon && <Icon icon={link.icon} className="text-xl text-blue-600 dark:text-blue-400" />}
                                <span>{link.name}</span>
                                <Icon
                                    icon="mdi:chevron-right"
                                    className="ml-auto text-xl opacity-60"
                                />
                            </Link>
                        ))}

                        {/* Secondary Links */}
                        <div className="pt-2 mt-2 border-t border-gray-200 dark:border-gray-700">
                            <p className="px-3 py-2 text-xs font-semibold uppercase text-gray-500 dark:text-gray-400">Resources</p>
                            <Link 
                                href="/events"
                                onClick={() => setOpen(false)}
                                className="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800 transition"
                            >
                                <Icon icon="mdi:calendar" className="text-lg text-gray-500" />
                                <span>Events</span>
                            </Link>
                            <Link 
                                href="/news"
                                onClick={() => setOpen(false)}
                                className="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800 transition"
                            >
                                <Icon icon="mdi:newspaper" className="text-lg text-gray-500" />
                                <span>University News</span>
                            </Link>
                            <Link 
                                href="/contact"
                                onClick={() => setOpen(false)}
                                className="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800 transition"
                            >
                                <Icon icon="mdi:phone" className="text-lg text-gray-500" />
                                <span>Contact Us</span>
                            </Link>
                        </div>

                        <div className="pt-2 mt-2 border-t border-gray-200 dark:border-gray-700">
                            <button
                                type="button"
                                onClick={() => setOpen(false)}
                                className="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition"
                            >
                                Close Menu
                            </button>
                        </div>
                    </div>
                </aside>
            </header>
            <main id="main" className="flex-grow">
                {children}
            </main>
            <footer className="bg-white dark:bg-gray-900 text-gray-600 dark:text-gray-300 p-6 border-t border-gray-200 dark:border-gray-700">
                <div className="max-w-7xl mx-auto">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
                        <div>
                            <img 
                                src="/assets/logo-full.png" 
                                alt="Uni-Hub Logo" 
                                className="block dark:hidden w-32 mb-4" 
                            />
                            <img 
                                src="/assets/logo-full-dark.png" 
                                alt="Uni-Hub Logo" 
                                className="hidden dark:block w-32 mb-4" 
                            />
                            <p className="text-sm">Your pathway to academic excellence and future success.</p>
                        </div>
                        <div>
                            <h3 className="font-semibold text-gray-800 dark:text-gray-100 mb-3">Quick Links</h3>
                            <ul className="space-y-2 text-sm">
                                <li><Link href="/about" className="hover:text-blue-600 dark:hover:text-blue-400">About Us</Link></li>
                                <li><Link href="/programs" className="hover:text-blue-600 dark:hover:text-blue-400">Programs</Link></li>
                                <li><Link href="/admissions" className="hover:text-blue-600 dark:hover:text-blue-400">Admissions</Link></li>
                                <li><Link href="/campus-life" className="hover:text-blue-600 dark:hover:text-blue-400">Campus Life</Link></li>
                            </ul>
                        </div>
                        <div>
                            <h3 className="font-semibold text-gray-800 dark:text-gray-100 mb-3">Resources</h3>
                            <ul className="space-y-2 text-sm">
                                <li><Link href="/library" className="hover:text-blue-600 dark:hover:text-blue-400">Library</Link></li>
                                <li><Link href="/research" className="hover:text-blue-600 dark:hover:text-blue-400">Research</Link></li>
                                <li><Link href="/career" className="hover:text-blue-600 dark:hover:text-blue-400">Career Services</Link></li>
                                <li><Link href="/alumni" className="hover:text-blue-600 dark:hover:text-blue-400">Alumni</Link></li>
                            </ul>
                        </div>
                        <div>
                            <h3 className="font-semibold text-gray-800 dark:text-gray-100 mb-3">Connect</h3>
                            <ul className="space-y-2 text-sm">
                                <li><Link href="/contact" className="hover:text-blue-600 dark:hover:text-blue-400">Contact Us</Link></li>
                                <li><Link href="/events" className="hover:text-blue-600 dark:hover:text-blue-400">Events</Link></li>
                                <li><Link href="/news" className="hover:text-blue-600 dark:hover:text-blue-400">News</Link></li>
                                <li>
                                    <div className="flex space-x-3 mt-2">
                                        <Link href="#" className="text-gray-600 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400">
                                            <Icon icon="mdi:facebook" className="text-xl" />
                                        </Link>
                                        <Link href="#" className="text-gray-600 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400">
                                            <Icon icon="mdi:twitter" className="text-xl" />
                                        </Link>
                                        <Link href="#" className="text-gray-600 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400">
                                            <Icon icon="mdi:instagram" className="text-xl" />
                                        </Link>
                                        <Link href="#" className="text-gray-600 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400">
                                            <Icon icon="mdi:linkedin" className="text-xl" />
                                        </Link>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div className="border-t border-gray-200 dark:border-gray-700 mt-8 pt-6 text-sm text-center">
                        <p>&copy; {new Date().getFullYear()} Uni-Hub. All rights reserved.</p>
                        <div className="mt-2 space-x-4">
                            <Link href="/privacy" className="hover:text-blue-600 dark:hover:text-blue-400">Privacy Policy</Link>
                            <Link href="/terms" className="hover:text-blue-600 dark:hover:text-blue-400">Terms of Service</Link>
                            <Link href="/accessibility" className="hover:text-blue-600 dark:hover:text-blue-400">Accessibility</Link>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    );
};

export default AppLayout;
